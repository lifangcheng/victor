#include "stm32f4xx.h"
#include "STM32_BSP.h"
#include "DAC121.h"

//==================================================================================================
//| 函数名称 | DAC_delay
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | I2C2延时
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | 无 
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 无
//==================================================================================================
void DAC_delay(void) 
{ 
    u8 i=200;  
    while (i)
    {
        i--;  
    }  
} 

void DAC_ldelay(void) 
{ 
    u8 i=200;  
    while (i)
    {
        i--;  
    }  
} 

//==================================================================================================
//| 函数名称 | DAC121S101_Init
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | DAC124S085初始化函数
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | 无 
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 无
//==================================================================================================  
void DAC121S101_Init(void)
{
    GPIO_InitTypeDef GPIO_InitStructure;
    //DAC
    GPIO_InitStructure.GPIO_Pin =  GPIO_Pin_12 | GPIO_Pin_9 | GPIO_Pin_10; 
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_OUT;
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;
    GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP;
    GPIO_Init(GPIOC, &GPIO_InitStructure);
	
	DAC121_CS_H;  
	DAC121_CLK_L;
	DAC121_DIN_L;	
}

//==================================================================================================
//| 函数名称 | DAC121S101_Write
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | DAC  0-5V输出
//|----------|--------------------------------------------------------------------------------------
//| 调用模块 | SPI0_DATA16
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | uin_Data:输出数据
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 无
//|----------|-------------------------------------------------------------------------------------- 
//| 函数设计 | victor
//==================================================================================================  
void DAC121S101_Write(INT16U uin_Data) 
{
	INT16U i;
    uin_Data = (0x0FFF & uin_Data);

    DAC121_CS_L; 
    DAC_ldelay();
	
	for(i=0;i<16;i++)
	{
		DAC121_CLK_H;
		if((uin_Data&(0x8000>>i)))
		{
			DAC121_DIN_H;
		}
		else
		{
			DAC121_DIN_L;
		}
		DAC_delay();
		DAC121_CLK_L;
		DAC_delay();
	}
	
	DAC121_CS_H;  
	DAC121_CLK_L;
	DAC121_DIN_L;	
    DAC_ldelay();
}


//==================================================================================================
//| 函数名称 | SetDA_Voltage
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | DAC  0-5V输出
//|----------|--------------------------------------------------------------------------------------
//| 调用模块 | SPI0_DATA16
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | f_Voltage:输出电压
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 无
//|----------|-------------------------------------------------------------------------------------- 
//| 函数设计 | victor
//================================================================================================== 
void SetDA_Voltage(FP32 f_Voltage)
{
    INT16U uin_Temp;
	
	uin_Temp = (INT16U)(f_Voltage / VOLTAGE_REF * RATIO);
	
	DAC121S101_Write(uin_Temp);
}

//==================================================================================================
//| 函数名称 | SetDA_HighVoltage
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | DAC  0-5V输出
//|----------|--------------------------------------------------------------------------------------
//| 调用模块 | SPI0_DATA16
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | f_Voltage:输出高压
//|----------|--------------------------------------------------------------------------------------       
//| 返回参数 | 无
//|----------|-------------------------------------------------------------------------------------- 
//| 函数设计 | victor
//================================================================================================== 
void SetDA_HighVoltage(FP32 f_Voltage)
{
    FP32 f_Temp;
	
	f_Temp = f_Voltage / VOLTAGE_GAIN;
	
	SetDA_Voltage(f_Temp);
}
